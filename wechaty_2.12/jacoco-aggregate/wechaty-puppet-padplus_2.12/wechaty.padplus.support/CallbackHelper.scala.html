<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>CallbackHelper.scala</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">wechaty_2.12</a> &gt; <a href="../index.html" class="el_bundle">wechaty-puppet-padplus_2.12</a> &gt; <a href="index.source.html" class="el_package">wechaty.padplus.support</a> &gt; <span class="el_source">CallbackHelper.scala</span></div><h1>CallbackHelper.scala</h1><pre class="source lang-java linenums">package wechaty.padplus.support

import java.util.concurrent.TimeUnit

import com.github.benmanes.caffeine.cache.{Cache, Caffeine}
import wechaty.padplus.grpc.PadPlusServerOuterClass.StreamResponse
import wechaty.padplus.schemas.ModelContact.PadplusContactPayload
import wechaty.padplus.schemas.ModelRoom.{PadplusRoomMemberMap, PadplusRoomPayload}

import scala.concurrent.Promise
import scala.util.{Success, Try}

/**
  *
  * @author &lt;a href=&quot;mailto:jcai@ganshane.com&quot;&gt;Jun Tsai&lt;/a&gt;
  * @since 2020-07-01
  */
<span class="fc" id="L18">object CallbackHelper {</span>
  private def createPool[T]: Cache[String, T]={
<span class="fc" id="L20">    Caffeine.newBuilder().maximumSize(1000)</span>
<span class="fc" id="L21">      .expireAfterWrite(5, TimeUnit.MINUTES) //按照高原建议设置5~10分钟</span>
      .build()
      .asInstanceOf[Cache[String, T]]
  }
  type TraceRequestCallback = Promise[StreamResponse]
<span class="nc bnc" id="L26" title="All 4 branches missed.">  lazy val traceCallbacks: Cache[String, TraceRequestCallback] = createPool[TraceRequestCallback]</span>

  type ContactPromise= Promise[PadplusContactPayload]
<span class="pc bpc" id="L29" title="1 of 4 branches missed.">  lazy val contactCallbacks: Cache[String, List[ContactPromise]] = createPool[List[ContactPromise]]</span>
  type RoomPromise= Promise[PadplusRoomPayload]
<span class="nc bnc" id="L31" title="All 4 branches missed.">  lazy val roomCallbacks: Cache[String, List[RoomPromise]] = createPool[List[RoomPromise]]</span>

  type ContactAliasCallback = Promise[Unit]
<span class="pc bpc" id="L34" title="2 of 4 branches missed.">  lazy val contactAliasCallbacks: Cache[String, Map[String, ContactAliasCallback]] = createPool[Map[String,ContactAliasCallback]]</span>


  type RoomTopicCallback= Promise[Unit]
<span class="nc bnc" id="L38" title="All 4 branches missed.">  lazy val roomTopicCallbacks: Cache[String, Map[String, RoomTopicCallback]] = createPool[Map[String,RoomTopicCallback]]</span>

  type AcceptFriendCallback= Promise[Unit]
<span class="pc bpc" id="L41" title="2 of 4 branches missed.">  lazy val acceptFriendCallbacks: Cache[String, List[AcceptFriendCallback]] = createPool[List[AcceptFriendCallback]]</span>

  type RoomMemberCallback= Promise[PadplusRoomMemberMap]
<span class="nc bnc" id="L44" title="All 4 branches missed.">  lazy val roomMemberCallbacks: Cache[String, List[RoomMemberCallback]] = createPool[List[RoomMemberCallback]]</span>

  def pushCallbackToPool (traceId: String, callback: TraceRequestCallback){
<span class="nc" id="L47">    traceCallbacks.put(traceId,callback)</span>
  }
  def resolveCallBack (traceId: String,response:StreamResponse):Unit={
<span class="nc" id="L50">    val callback = traceCallbacks.getIfPresent(traceId)</span>
<span class="nc bnc" id="L51" title="All 2 branches missed.">    if(callback!=null){</span>
<span class="nc" id="L52">      callback.success(response)</span>
    }
<span class="nc" id="L54">    traceCallbacks.invalidate(traceId)</span>
  }

  def removeCallback (traceId: String): Unit = {
<span class="nc" id="L58">    traceCallbacks.invalidate(traceId)</span>
  }

  private def pushListCallback[T](cache:Cache[String,List[T]],key:String,callback:T): Unit ={
<span class="fc" id="L62">      val callbackList = cache.getIfPresent(key)</span>
<span class="fc bfc" id="L63" title="All 2 branches covered.">      if(callbackList == null){</span>
<span class="fc" id="L64">        cache.put(key,List(callback))</span>
      }else{
<span class="fc" id="L66">        cache.put(key,callbackList :+ callback)</span>
      }
  }
  private def resolveListCallBack[T] (cache:Cache[String,List[Promise[T]]],key: String, data: Try[T]) {
<span class="fc" id="L70">    val callbackList = cache.getIfPresent(key)</span>
<span class="fc bfc" id="L71" title="All 2 branches covered.">    if (callbackList != null) {</span>
<span class="fc" id="L72">      callbackList.foreach(f =&gt; f.complete(data))</span>
<span class="fc" id="L73">      cache.invalidate(key)</span>
    }
  }

  def pushContactCallback ( contactId: String, callback:ContactPromise) {
<span class="fc" id="L78">    pushListCallback(contactCallbacks,contactId,callback)</span>
  }

  def resolveContactCallBack (contactId: String, data: Try[PadplusContactPayload]) {
<span class="fc" id="L82">    resolveListCallBack(contactCallbacks,contactId,data)</span>

<span class="fc" id="L84">    data match{</span>
<span class="pc bpc" id="L85" title="1 of 2 branches missed.">      case Success(value) =&gt;</span>
<span class="fc" id="L86">        this.resolveContactAliasCallback(contactId, value.remark)</span>
<span class="fc" id="L87">        this.resolveAcceptFriendCallback(contactId)</span>
<span class="nc" id="L88">      case _ =&gt;</span>
    }
  }

  def pushRoomCallback ( roomId: String, callback:RoomPromise) {
<span class="nc" id="L93">    pushListCallback(roomCallbacks,roomId,callback)</span>
  }
  def resolveRoomCallBack (roomId: String, data: Try[PadplusRoomPayload]) {
<span class="nc" id="L96">    resolveListCallBack(roomCallbacks,roomId,data)</span>
<span class="nc" id="L97">    data match{</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">      case Success(value) =&gt;</span>
<span class="nc" id="L99">        this.resolveRoomTopicCallback(value.chatroomId, value.nickName)</span>
<span class="nc" id="L100">      case _ =&gt; //do nothing</span>
    }
  }

  private def pushMapCallback[T](cache:Cache[String,Map[String,Promise[T]]],key:String,mapKey:String,callback:Promise[T]): Unit ={
<span class="nc" id="L105">    val callbacks = cache.getIfPresent(key)</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">    if(callbacks == null){</span>
<span class="nc" id="L107">      cache.put(key,Map(mapKey-&gt;callback))</span>
    }else{
<span class="nc" id="L109">      cache.put(key,callbacks + (mapKey-&gt;callback))</span>
    }
  }
  def pushContactAliasCallback (contactId: String, alias: String, callback:ContactAliasCallback): Unit = {
<span class="nc" id="L113">    pushMapCallback(contactAliasCallbacks,contactId,alias,callback)</span>
  }
  private def resolveMapCallback(cache:Cache[String,Map[String,Promise[Unit]]],key: String, mapKey: String) {
<span class="fc" id="L116">    val callbacks = cache.getIfPresent(key)</span>
<span class="pc bpc" id="L117" title="1 of 2 branches missed.">    if(callbacks != null){</span>
<span class="nc" id="L118">      val callbackOpt = callbacks.get(mapKey)</span>
<span class="nc" id="L119">      callbackOpt.foreach{f=&gt;</span>
<span class="nc" id="L120">        f.success({})</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">        if(callbacks.size == 1)</span>
<span class="nc" id="L122">          cache.invalidate(key)</span>
        else
<span class="nc bnc" id="L124" title="All 8 branches missed.">          cache.put(key,callbacks.filterNot{case (key,_) =&gt; key == mapKey})</span>
      }
    }
  }
  private def resolveContactAliasCallback (contactId: String, alias: String) {
<span class="fc" id="L129">    resolveMapCallback(contactAliasCallbacks,contactId,alias)</span>
  }

  def pushRoomTopicCallback (roomId: String, topic: String, callback: RoomTopicCallback) {
<span class="nc" id="L133">    pushMapCallback(roomTopicCallbacks,roomId,topic,callback)</span>
  }

  private def resolveRoomTopicCallback (roomId: String, topic: String) {
<span class="nc" id="L137">    resolveMapCallback(roomTopicCallbacks,roomId,topic)</span>
  }

  def pushAcceptFriendCallback (contactId: String, callback: AcceptFriendCallback) {
<span class="nc" id="L141">    pushListCallback(acceptFriendCallbacks,contactId,callback)</span>
  }

  private def resolveAcceptFriendCallback (contactId: String) {
<span class="fc" id="L145">    resolveListCallBack(acceptFriendCallbacks,contactId,Try[Unit]({}))</span>
  }

  def pushRoomMemberCallback (roomId: String, callback: RoomMemberCallback): Unit ={
<span class="nc" id="L149">    pushListCallback(roomMemberCallbacks,roomId,callback)</span>
  }

  def resolveRoomMemberCallback (roomId: String, memberList: Try[PadplusRoomMemberMap]) {
<span class="nc" id="L153">    resolveListCallBack(roomMemberCallbacks,roomId,memberList)</span>
  }
<span class="fc" id="L155">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>