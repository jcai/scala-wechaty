<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MessageRawSupport.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wechaty-puppet-padplus_2.12</a> &gt; <a href="index.source.html" class="el_package">wechaty.padplus.support</a> &gt; <span class="el_source">MessageRawSupport.scala</span></div><h1>MessageRawSupport.scala</h1><pre class="source lang-java linenums">package wechaty.padplus.support

import com.fasterxml.jackson.dataformat.xml.XmlMapper
import com.typesafe.scalalogging.LazyLogging
import wechaty.padplus.grpc.PadPlusServerOuterClass.{ApiType, ResponseType, StreamResponse}
import wechaty.padplus.schemas.GrpcSchemas.GrpcMessagePayload
import wechaty.padplus.schemas.ModelMessage.PadplusMessagePayload
import wechaty.padplus.schemas.PadplusEnums.PadplusMessageType
import wechaty.puppet.ResourceBox
import wechaty.puppet.events.EventEmitter
import wechaty.puppet.schemas.Event.EventMessagePayload
import wechaty.puppet.schemas.Image.ImageType.Type
import wechaty.puppet.schemas.Message.{MessagePayload, MessageType}
import wechaty.puppet.schemas.Puppet.{PuppetEventName, isBlank, objectMapper}
import wechaty.puppet.schemas.{Message, MiniProgram, Puppet, UrlLink}
import wechaty.puppet.support.MessageSupport

/**
  *
  * @author &lt;a href=&quot;mailto:jcai@ganshane.com&quot;&gt;Jun Tsai&lt;/a&gt;
  * @since 2020-06-22
  */
<span class="fc" id="L23">trait MessageRawSupport {</span>
  self:GrpcSupport with EventEmitter with GrpcEventSupport with PadplusHelper with LazyLogging with MessageSupport with LocalStoreSupport =&gt;
  /**
    * message
    */
<span class="nc" id="L28">  override def messageContact(messageId: String): String = ???</span>

<span class="nc" id="L30">  override def messageFile(messageId: String): ResourceBox = ???</span>

<span class="nc" id="L32">  override def messageImage(messageId: String, imageType: Type): ResourceBox = ???</span>

<span class="nc" id="L34">  override def messageMiniProgram(messageId: String): MiniProgram.MiniProgramPayload = ???</span>

<span class="nc" id="L36">  override def messageUrl(messageId: String): UrlLink.UrlLinkPayload = ???</span>

<span class="nc" id="L38">  override def messageSendContact(conversationId: String, contactId: String): String = ???</span>

  override def messageSendFile(conversationId: String, file: ResourceBox): String = {
//    val url = file.resourceType match{
//      case ResourceBoxType.Url =&gt; file.url
//      case _ =&gt; uploadFile(file.name,file.toStream)
//    }

    /*
    data = {
      fileName,
      fromUserName: selfId,
      messageType: PadplusMessageType.Image,
      subType,
      toUserName: receiver,
      url,
    }
    const res = await this.requestClient.request({
      apiType: ApiType.SEND_FILE,
      data,
    })
     */
<span class="nc" id="L60">    ???</span>
  }

<span class="nc" id="L63">  override def messageSendMiniProgram(conversationId: String, miniProgramPayload: MiniProgram.MiniProgramPayload): String = ???</span>

  override def messageSendText(conversationId: String, text: String, mentionIdList: Array[String]): String = {
<span class="nc" id="L66">    val json = Puppet.objectMapper.createObjectNode()</span>
<span class="nc" id="L67">    json.put(&quot;content&quot;,text)</span>
<span class="nc" id="L68">    json.put(&quot;messageType&quot;,PadplusMessageType.Text.id)</span>
<span class="nc" id="L69">    json.put(&quot;fromUserName&quot;,selfId.get)</span>
<span class="nc" id="L70">    json.put(&quot;toUserName&quot;,conversationId)</span>
<span class="nc" id="L71">    val payload = syncRequest[GrpcMessagePayload](ApiType.SEND_MESSAGE,Some(json.toString))</span>
<span class="nc" id="L72">    payload.MsgId</span>
  }

<span class="nc" id="L75">  override def messageSendUrl(conversationId: String, urlLinkPayload: UrlLink.UrlLinkPayload): String = ???</span>

<span class="nc" id="L77">  override def messageRecall(messageId: String): Boolean = ???</span>


  override protected def messageRawPayload(messageId: String): Message.MessagePayload = {
<span class="nc" id="L81">    getPadplusMessagePayload(messageId) match {</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">      case Some(rawPayload) =&gt;</span>
<span class="nc" id="L83">        val messagePayload = new MessagePayload</span>
<span class="nc" id="L84">        messagePayload.id = rawPayload.msgId</span>
<span class="nc" id="L85">        messagePayload.`type` = messageType(rawPayload.msgType)</span>

        /**
          * 1. Set Room Id
          */
<span class="nc bnc" id="L90" title="All 2 branches missed.">        if (isRoomId(rawPayload.fromUserName)) {</span>
<span class="nc" id="L91">          messagePayload.roomId = rawPayload.fromUserName</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">        } else if (isRoomId(rawPayload.toUserName)) {</span>
<span class="nc" id="L93">          messagePayload.roomId = rawPayload.toUserName</span>
        }

        /**
          * 2. Set To Contact Id
          */
<span class="nc bnc" id="L99" title="All 2 branches missed.">        if (isContactId(rawPayload.toUserName)) {</span>

<span class="nc" id="L101">          messagePayload.toId = rawPayload.toUserName</span>
        }

        /**
          * 3. Set From Contact Id
          */
<span class="nc bnc" id="L107" title="All 2 branches missed.">        if (isContactId(rawPayload.fromUserName)) {</span>

<span class="nc" id="L109">          messagePayload.fromId = rawPayload.fromUserName</span>

        } else {
<span class="nc" id="L112">          val parts = rawPayload.content.split(&quot;:\n&quot;)</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">          if (parts.length &gt; 1) {</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">            if (isContactId(parts(0))) {</span>
<span class="nc" id="L115">              messagePayload.fromId = parts(0)</span>
            }
          }
        }

        /**
          *
          * 4. Set Text
          */
<span class="nc bnc" id="L124" title="All 2 branches missed.">        if (isRoomId(rawPayload.fromUserName)) {</span>

<span class="nc" id="L126">          val startIndex = rawPayload.content.indexOf(&quot;:\n&quot;)</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">          messagePayload.text = rawPayload.content.substring(if (startIndex != -1) startIndex + 2 else 0)</span>

        } else {
<span class="nc" id="L130">          messagePayload.text = rawPayload.content</span>
        }

<span class="nc bnc" id="L133" title="All 6 branches missed.">        if (messagePayload.`type` == MessageType.Recalled) {</span>
          //not supported
        }


        /**
          * 6. Set mention list, only for room messages
          */
<span class="nc bnc" id="L141" title="All 2 branches missed.">        if (!isBlank(messagePayload.roomId)) {</span>
<span class="nc" id="L142">          val xmlMapper = new XmlMapper();</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">          if(!Puppet.isBlank(rawPayload.msgSource)) {</span>
<span class="nc" id="L144">            val root = xmlMapper.readTree(rawPayload.msgSource)</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">            if (root.has(&quot;atuserlist&quot;)) {</span>
<span class="nc" id="L146">              messagePayload.mentionIdList = root.get(&quot;atuserlist&quot;).asText().split(&quot;,&quot;)</span>
            }
          }
        }

        /**
          * 6. Set Contact for ShareCard
          */
        /* if (type === MessageType.Contact) {
        const xml = await xmlToJson(rawPayload.content.split('\n')[1])
        log.silly(PRE, `xml : ${JSON.stringify(xml)}`)
        const shareCardData = xml.msg.$
        text = JSON.stringify(shareCardData)
      } */

<span class="nc" id="L161">        messagePayload</span>
      case _ =&gt;
<span class="nc" id="L163">        throw new IllegalAccessException(&quot;message not found by &quot; + messageId)</span>
    }
  }

<span class="nc" id="L167">  override protected def ding(data: String): Unit = ???</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">  def messagePartialFunction(response:StreamResponse):PartialFunction[ResponseType,Unit] = {</span>
<span class="nc bnc" id="L169" title="All 4 branches missed.">    case ResponseType.MESSAGE_RECEIVE =&gt;</span>
<span class="nc" id="L170">      val rawMessageStr                            = response.getData()</span>
<span class="nc" id="L171">      val payload                                  = objectMapper.readValue(rawMessageStr, classOf[GrpcMessagePayload])</span>
<span class="nc" id="L172">      val eventMessagePayload                      = new EventMessagePayload</span>
<span class="nc" id="L173">      eventMessagePayload.messageId = payload.MsgId</span>
<span class="nc" id="L174">      savePadplusMessagePayload(payload)</span>
<span class="nc" id="L175">      emit(PuppetEventName.MESSAGE, eventMessagePayload)</span>
  }
  private implicit def convertMessageFromGrpcToPadplus (rawMessage: GrpcMessagePayload): PadplusMessagePayload= {
<span class="nc" id="L178">    val padplusMessagePayload = new  PadplusMessagePayload</span>
<span class="nc" id="L179">    padplusMessagePayload.appMsgType= rawMessage.AppMsgType</span>
<span class="nc" id="L180">    padplusMessagePayload.content= rawMessage.Content</span>
<span class="nc" id="L181">    padplusMessagePayload.createTime= rawMessage.CreateTime</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">    padplusMessagePayload.fileName= if(isBlank(rawMessage.FileName))  rawMessage.fileName else rawMessage.FileName</span>
<span class="nc" id="L183">    padplusMessagePayload.fromMemberNickName= rawMessage.FromMemberNickName</span>
<span class="nc" id="L184">    padplusMessagePayload.fromMemberUserName= rawMessage.FromMemberUserName</span>
<span class="nc" id="L185">    padplusMessagePayload.fromUserName= rawMessage.FromUserName</span>
<span class="nc" id="L186">    padplusMessagePayload.imgBuf= rawMessage.ImgBuf</span>
<span class="nc" id="L187">    padplusMessagePayload.imgStatus= rawMessage.ImgStatus</span>
<span class="nc" id="L188">    padplusMessagePayload.l1MsgType= rawMessage.L1MsgType</span>
<span class="nc" id="L189">    padplusMessagePayload.msgId= rawMessage.MsgId</span>
<span class="nc" id="L190">    padplusMessagePayload.msgSource= rawMessage.MsgSource</span>
<span class="nc" id="L191">    padplusMessagePayload.msgSourceCd= rawMessage.msgSourceCd</span>
<span class="nc" id="L192">    padplusMessagePayload.msgType= PadplusMessageType(rawMessage.MsgType)</span>
<span class="nc" id="L193">    padplusMessagePayload.newMsgId= rawMessage.NewMsgId</span>
<span class="nc" id="L194">    padplusMessagePayload.pushContent= rawMessage.PushContent</span>
<span class="nc" id="L195">    padplusMessagePayload.status= rawMessage.Status</span>
<span class="nc" id="L196">    padplusMessagePayload.toUserName= rawMessage.ToUserName</span>
<span class="nc" id="L197">    padplusMessagePayload.uin= rawMessage.Uin</span>
<span class="nc" id="L198">    padplusMessagePayload.url= rawMessage.Url</span>
<span class="nc" id="L199">    padplusMessagePayload.wechatUserName= rawMessage.wechatUserName</span>
<span class="nc" id="L200">    padplusMessagePayload</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>