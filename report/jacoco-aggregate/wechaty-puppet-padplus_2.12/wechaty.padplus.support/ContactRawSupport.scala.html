<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ContactRawSupport.scala</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">report</a> &gt; <a href="../index.html" class="el_bundle">wechaty-puppet-padplus_2.12</a> &gt; <a href="index.source.html" class="el_package">wechaty.padplus.support</a> &gt; <span class="el_source">ContactRawSupport.scala</span></div><h1>ContactRawSupport.scala</h1><pre class="source lang-java linenums">package wechaty.padplus.support

import java.util

import com.google.protobuf.ByteString
import com.google.zxing.client.j2se.BufferedImageLuminanceSource
import com.google.zxing.common.HybridBinarizer
import com.google.zxing.{BinaryBitmap, DecodeHintType, MultiFormatReader}
import com.typesafe.scalalogging.LazyLogging
import javax.imageio.ImageIO
import wechaty.padplus.PuppetPadplus
import wechaty.padplus.grpc.PadPlusServerOuterClass.{ApiType, ResponseType, StreamResponse}
import wechaty.padplus.schemas.GrpcSchemas.GrpcQrCodeLogin
import wechaty.padplus.schemas.ModelContact.{GrpcContactPayload, PadplusContactPayload}
import wechaty.padplus.schemas.ModelRoom.GrpcRoomPayload
import wechaty.padplus.schemas.ModelUser.ScanData
import wechaty.padplus.schemas.PadplusEnums.QrcodeStatus
import wechaty.puppet.ResourceBox
import wechaty.puppet.schemas.Contact.{ContactGender, ContactPayload, ContactType}
import wechaty.puppet.schemas.Event.{EventLoginPayload, EventScanPayload}
import wechaty.puppet.schemas.Puppet._
import wechaty.puppet.schemas.{Contact, Puppet}

import scala.concurrent.Future
import scala.language.implicitConversions
import scala.util.Try

/**
  *
  * @author &lt;a href=&quot;mailto:jcai@ganshane.com&quot;&gt;Jun Tsai&lt;/a&gt;
  * @since 2020-06-21
  */
<span class="fc" id="L33">trait ContactRawSupport extends LazyLogging{</span>
  self: PuppetPadplus =&gt;

<span class="nc" id="L36">  override def contactAlias(contactId: String): Future[String] = ???</span>

<span class="nc" id="L38">  override def contactAlias(contactId: String, alias: String): Future[Nothing] = ???</span>

<span class="nc" id="L40">  override def contactAvatar(contactId: String): Future[ResourceBox] = ???</span>

<span class="nc" id="L42">  override def contactAvatar(contactId: String, file: ResourceBox): Future[ResourceBox] = ???</span>

<span class="nc" id="L44">  override def contactList(): Future[Array[String]] = ???</span>

  /**
    * contact
    */
  override protected def contactRawPayload(contactId: String): Future[Contact.ContactPayload] = {
<span class="fc" id="L50">    this.getContact(contactId).map(convertPadplusContactToContactPayload)</span>
  }

  protected def getContact(contactId: String): Future[PadplusContactPayload] = {
<span class="fc" id="L54">    getPadplusContactPayload(contactId) match{</span>
<span class="pc bpc" id="L55" title="1 of 2 branches missed.">      case Some(padplusContactPayload) =&gt; Future.successful(padplusContactPayload)</span>
      case _ =&gt;
<span class="fc" id="L57">        val json = objectMapper.createObjectNode()</span>
<span class="fc" id="L58">        json.put(&quot;userName&quot;, contactId)</span>
<span class="fc" id="L59">        asyncRequest[GrpcContactPayload](ApiType.GET_CONTACT,Some(json.toString)).map(convertFromGrpcContact)</span>
    }
  }

<span class="nc bnc" id="L63" title="All 2 branches missed.">  protected def loginPartialFunction(response: StreamResponse): PartialFunction[ResponseType, Unit] = {</span>
<span class="nc bnc" id="L64" title="All 4 branches missed.">    case ResponseType.QRCODE_SCAN =&gt;</span>
<span class="nc" id="L65">      onQrcodeScan(response)</span>
<span class="nc bnc" id="L66" title="All 4 branches missed.">    case ResponseType.LOGIN_QRCODE =&gt;</span>
<span class="nc" id="L67">      val qrcodeData = objectMapper.readTree(response.getData)</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">      logger.debug(&quot;qrcode:&quot;,response.getData)</span>

<span class="nc" id="L70">      val base64            = qrcodeData.get(&quot;qrcode&quot;).asText().replaceAll(&quot;\r|\n&quot;, &quot;&quot;)</span>
<span class="nc" id="L71">      val fileBox           = ResourceBox.fromBase64(s&quot;qrcode${(Math.random() * 10000).intValue()}.png&quot;, base64)</span>
      //解析二维码的类
<span class="nc" id="L73">      val multiFormatReader = new MultiFormatReader();</span>
      //要解析的二维码的图片
<span class="nc" id="L75">      val bufferedImage     = ImageIO.read(fileBox.toStream);</span>
<span class="nc" id="L76">      val binaryBitmap      = new BinaryBitmap(new HybridBinarizer(new BufferedImageLuminanceSource(bufferedImage)));</span>
      //二维码的参数设置
<span class="nc" id="L78">      val hints             = new util.HashMap[DecodeHintType, String]();</span>
<span class="nc" id="L79">      hints.put(DecodeHintType.CHARACTER_SET, &quot;utf-8&quot;); //设置二维码的编码</span>
    //得到解析结果,
<span class="nc" id="L81">    val result  = multiFormatReader.decode(binaryBitmap, hints);</span>
<span class="nc" id="L82">    val payload = new EventScanPayload</span>
<span class="nc" id="L83">      payload.qrcode = result.getText</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">      logger.debug(&quot;Scan QR Code to login: %s\nhttps://wechaty.github.io/qrcode/%s\n&quot;.format(payload.status, payload.qrcode))</span>
<span class="nc" id="L85">      emit(PuppetEventName.SCAN, payload)</span>
<span class="nc bnc" id="L86" title="All 4 branches missed.">    case ResponseType.QRCODE_LOGIN =&gt;</span>
<span class="nc" id="L87">      val loginData             = objectMapper.readValue(response.getData, classOf[GrpcQrCodeLogin])</span>
<span class="nc" id="L88">      this.selfId = Some(loginData.userName)</span>
<span class="nc" id="L89">      this.saveUin(ByteString.copyFromUtf8(loginData.uin))</span>
<span class="nc" id="L90">      val padplusContactPayload = new PadplusContactPayload</span>
<span class="nc" id="L91">      padplusContactPayload.alias = loginData.alias</span>
<span class="nc" id="L92">      padplusContactPayload.bigHeadUrl = loginData.headImgUrl</span>
<span class="nc" id="L93">      padplusContactPayload.nickName = loginData.nickName</span>
<span class="nc" id="L94">      padplusContactPayload.sex = ContactGender.Unknown</span>
<span class="nc" id="L95">      padplusContactPayload.userName = loginData.userName</span>
<span class="nc" id="L96">      padplusContactPayload.verifyFlag = 0</span>
<span class="nc" id="L97">      savePadplusContactPayload( padplusContactPayload)</span>
<span class="nc" id="L98">      val eventLoginPayload = new EventLoginPayload</span>
<span class="nc" id="L99">      eventLoginPayload.contactId = padplusContactPayload.userName</span>
<span class="nc" id="L100">      emit(PuppetEventName.LOGIN, eventLoginPayload)</span>

<span class="nc" id="L102">      Future {</span>
<span class="nc" id="L103">        getContact(padplusContactPayload.userName)</span>
      }
<span class="nc bnc" id="L105" title="All 4 branches missed.">    case ResponseType.AUTO_LOGIN =&gt;</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">      logger.debug(&quot;response data:{}&quot;, response.getData)</span>
<span class="nc" id="L107">      val autoLoginData = objectMapper.readTree(response.getData)</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">      if (autoLoginData.get(&quot;online&quot;).asBoolean()) {</span>
<span class="nc" id="L109">        val wechatUser = autoLoginData.get(&quot;wechatUser&quot;)</span>

<span class="nc bnc" id="L111" title="All 2 branches missed.">        if (wechatUser != null) {</span>
<span class="nc" id="L112">          val rawContactPayload = new PadplusContactPayload</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">          if (wechatUser.has(&quot;alias&quot;))</span>
<span class="nc" id="L114">            rawContactPayload.alias = wechatUser.get(&quot;alias&quot;).asText(&quot;&quot;)</span>
<span class="nc" id="L115">          rawContactPayload.bigHeadUrl = wechatUser.get(&quot;headImgUrl&quot;).asText()</span>
<span class="nc" id="L116">          rawContactPayload.nickName = wechatUser.get(&quot;nickName&quot;).asText()</span>
<span class="nc" id="L117">          rawContactPayload.sex = ContactGender.Unknown</span>
<span class="nc" id="L118">          rawContactPayload.userName = wechatUser.get(&quot;userName&quot;).asText()</span>
<span class="nc" id="L119">          savePadplusContactPayload(rawContactPayload)</span>
          // &quot;{\&quot;uin\&quot;:1213374243,\&quot;online\&quot;:true,\&quot;wechatUser\&quot;:{\&quot;headImgUrl\&quot;:\&quot;http://wx.qlogo.cn/mmhead/ver_1/iag5D2R2U9ibgTW2eh7XUbPTHqpEMP2DhSpXSBeQYzEPWgEmLIx5IDibwicGh4fTh4IibkL4hNianoiaTzXmVORnm1O4ZjhxfPosKzkMPSwic8Iicylk/0\&quot;,\&quot;nickName\&quot;:\&quot;\351\230\277\350\224\241\&quot;,\&quot;uin\&quot;:1213374243,\&quot;userName\&quot;:\&quot;wxid_gbk03zsepqny22\&quot;,\&quot;alias\&quot;:\&quot;\&quot;,\&quot;verifyFlag\&quot;:0}}&quot;
<span class="nc" id="L121">          selfId = Some(rawContactPayload.userName)</span>
        }

//        contactSelfInfo { padplusContact =&gt;
//          selfId = Some(padplusContact.userName)
//          logger.debug(&quot;contactSelf:{}&quot;, padplusContact)
//          savePadplusContactPayload(padplusContact)
//          val eventLoginPayload = new EventLoginPayload
//          eventLoginPayload.contactId = padplusContact.userName
//          emit(PuppetEventName.LOGIN, eventLoginPayload)
//        }
      } else {
<span class="nc" id="L133">        deleteUin()</span>
<span class="nc" id="L134">        asyncRequest(ApiType.GET_QRCODE)</span>
      }
<span class="nc bnc" id="L136" title="All 12 branches missed.">    case ResponseType.CONTACT_LIST | ResponseType.CONTACT_MODIFY =&gt;</span>
<span class="nc" id="L137">      val data = response.getData</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">      if(!isBlank(data)){</span>
<span class="nc" id="L139">        val root = objectMapper.readTree(data)</span>
<span class="nc" id="L140">        val userName = root.get(&quot;UserName&quot;).asText()</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">        if(isRoomId(userName)){</span>
<span class="nc" id="L142">          val roomTry=Try {</span>
<span class="nc" id="L143">            val grpcRoomPayload = objectMapper.readValue(data, classOf[GrpcRoomPayload])</span>
<span class="nc" id="L144">            val roomPayload     = convertRoomFromGrpc(grpcRoomPayload)</span>
            /* //TODO process room members
            const roomMembers = briefRoomMemberParser(roomPayload.members)
            const _roomMembers = await this.cacheManager.getRoomMember(roomPayload.chatroomId)
            if (!_roomMembers) {
              await this.cacheManager.setRoomMember(roomPayload.chatroomId, roomMembers)
            }
            await this.cacheManager.setRoom(roomPayload.chatroomId, roomPayload)
          } else {
            throw new PadplusError(PadplusErrorType.NO_CACHE, `CONTACT_MODIFY`)
          }
           */
<span class="nc" id="L156">            savePadplusRoomPayload(roomPayload)</span>

<span class="nc" id="L158">            roomPayload</span>
          }
          //TODO use Try instance to avoid memory leak
<span class="nc bnc" id="L161" title="All 2 branches missed.">          if(roomTry.isSuccess)</span>
<span class="nc" id="L162">            CallbackHelper.resolveRoomCallBack(userName,roomTry.get)</span>

        }else{
<span class="nc" id="L165">          val result:Try[PadplusContactPayload] = Try {</span>
<span class="nc" id="L166">            val contact               = objectMapper.readValue(data, classOf[GrpcContactPayload])</span>
<span class="nc" id="L167">            val padplusContactPayload = convertFromGrpcContact(contact)</span>
<span class="nc" id="L168">            savePadplusContactPayload(padplusContactPayload)</span>
<span class="nc" id="L169">            padplusContactPayload</span>
          }

          //TODO use Try instance to avoid memory leak
<span class="nc bnc" id="L173" title="All 2 branches missed.">          if(result.isSuccess)</span>
<span class="nc" id="L174">            CallbackHelper.resolveContactCallBack(userName,result.get)</span>
        }
      }
  }

  private def onQrcodeScan(response: StreamResponse): Unit = {
<span class="nc" id="L180">    val scanRawData = response.getData()</span>
<span class="nc" id="L181">    val scanData    = objectMapper.readValue(scanRawData, classOf[ScanData])</span>
<span class="nc" id="L182">    QrcodeStatus(scanData.status.intValue()) match {</span>
<span class="nc bnc" id="L183" title="All 6 branches missed.">      case QrcodeStatus.Scanned =&gt;</span>

<span class="nc bnc" id="L185" title="All 6 branches missed.">      case QrcodeStatus.Confirmed =&gt;</span>
//        contactSelfInfo { padplusContact =&gt;
//          selfId = Some(padplusContact.userName)
//          logger.debug(&quot;contactSelf:{}&quot;, padplusContact)
//          savePadplusContactPayload(padplusContact)
//          val eventLoginPayload = new EventLoginPayload
//          eventLoginPayload.contactId = padplusContact.userName
//          emit(PuppetEventName.LOGIN, eventLoginPayload)
//        }
<span class="nc bnc" id="L194" title="All 14 branches missed.">      case QrcodeStatus.Canceled | QrcodeStatus.Expired =&gt;</span>

    }
  }

  implicit def convertFromGrpcContact (contactPayload: GrpcContactPayload): PadplusContactPayload = {
<span class="fc" id="L200">    val payload = new PadplusContactPayload</span>
<span class="fc" id="L201">    payload.alias            = contactPayload.Alias</span>
<span class="fc" id="L202">    payload.bigHeadUrl       = contactPayload.BigHeadImgUrl</span>
<span class="fc" id="L203">    payload.city             = contactPayload.City</span>
<span class="fc" id="L204">    payload.contactFlag      = contactPayload.ContactFlag</span>
<span class="pc bpc" id="L205" title="1 of 2 branches missed.">    payload.contactType      = if(Puppet.isBlank(contactPayload.ContactType)) 0 else contactPayload.ContactType.toInt</span>
<span class="fc" id="L206">    payload.country          = &quot;&quot;</span>
<span class="fc" id="L207">    payload.nickName         = contactPayload.NickName</span>
<span class="fc" id="L208">    payload.province         = contactPayload.Province</span>
<span class="fc" id="L209">    payload.remark           = contactPayload.RemarkName</span>
<span class="fc" id="L210">    payload.sex              = Contact.ContactGender(contactPayload.Sex.intValue())</span>
<span class="fc" id="L211">    payload.signature        = contactPayload.Signature</span>
<span class="fc" id="L212">    payload.smallHeadUrl     = contactPayload.SmallHeadImgUrl</span>
<span class="fc" id="L213">    payload.stranger         = contactPayload.EncryptUsername</span>
<span class="fc" id="L214">    payload.tagList          = contactPayload.LabelLists</span>
<span class="fc" id="L215">    payload.ticket           = &quot;&quot;</span>
<span class="fc" id="L216">    payload.userName         = contactPayload.UserName</span>
<span class="fc" id="L217">    payload.verifyFlag       = contactPayload.VerifyFlag</span>

<span class="fc" id="L219">    payload</span>
  }
  implicit def convertPadplusContactToContactPayload(rawPayload:PadplusContactPayload): ContactPayload ={
<span class="pc bpc" id="L222" title="1 of 2 branches missed.">    if (isRoomId(rawPayload.userName)) {</span>
<span class="nc" id="L223">      throw new Error(&quot;Room Object instead of Contact!&quot;)</span>
    }

<span class="fc" id="L226">    var contactType = ContactType.Unknown</span>
<span class="pc bpc" id="L227" title="2 of 4 branches missed.">    if (isContactOfficialId(rawPayload.userName) || rawPayload.verifyFlag != 0) {</span>
<span class="nc" id="L228">      contactType = ContactType.Official</span>
    } else {
<span class="fc" id="L230">      contactType = ContactType.Personal</span>
    }
<span class="fc" id="L232">    var friend = false</span>
<span class="pc bpc" id="L233" title="5 of 6 branches missed.">    if (rawPayload.contactFlag &gt; 0 &amp;&amp; rawPayload.contactFlag != 0 &amp;&amp; rawPayload.verifyFlag == 0) {</span>
<span class="nc" id="L234">      friend = true</span>
    }
<span class="fc" id="L236">    val payload = new ContactPayload</span>
<span class="fc" id="L237">      payload.alias     = rawPayload.remark</span>
<span class="fc" id="L238">      payload.avatar    = rawPayload.bigHeadUrl</span>
<span class="fc" id="L239">      payload.city      = rawPayload.city</span>
<span class="fc" id="L240">      payload.friend    = friend</span>
<span class="fc" id="L241">      payload.gender    = rawPayload.sex</span>
<span class="fc" id="L242">      payload.id        = rawPayload.userName</span>
<span class="fc" id="L243">      payload.name      = rawPayload.nickName</span>
<span class="fc" id="L244">      payload.province  = rawPayload.province</span>
<span class="fc" id="L245">      payload.signature = (rawPayload.signature).replace(&quot;+&quot;, &quot;&quot;)          // Stay+Foolis</span>
<span class="fc" id="L246">      payload.`type`      = contactType</span>
<span class="fc" id="L247">      payload.weixin    = rawPayload.alias</span>

<span class="fc" id="L249">    payload</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>